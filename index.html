<script>
let startX, startY, endX, endY;
let isDrawing = false;
let cropRect = null;
let originalPageWidth = 0;
let originalPageHeight = 0;
let scaleFactor = 1;
let uploadedFile;
let pdfPage;
let pdfViewport;
let pdfRenderedImageData = null;
let pageCount = 1; // NEW

const canvas = document.getElementById('pdfCanvas');
const ctx = canvas.getContext('2d');
const errorMsg = document.getElementById('errorMsg');
const successMsg = document.getElementById('successMsg');

function showError(msg) {
  errorMsg.style.display = 'block';
  errorMsg.textContent = msg;
  setTimeout(() => errorMsg.style.display = 'none', 4000);
}
function showSuccess(msg) {
  successMsg.style.display = 'block';
  successMsg.textContent = msg;
  setTimeout(() => successMsg.style.display = 'none', 4000);
}

document.getElementById('pdfInput').addEventListener('change', async function(e) {
  cropRect = null;
  const file = e.target.files[0];
  if (!file || file.type !== 'application/pdf') { showError('Please upload a valid PDF file.'); return; }
  uploadedFile = file;
  const fileReader = new FileReader();
  fileReader.onload = async function() {
    try {
      const typedarray = new Uint8Array(this.result);
      const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
      pageCount = pdf.numPages; // NEW: get total pages
      pdfPage = await pdf.getPage(1);
      pdfViewport = pdfPage.getViewport({ scale: 1.5 });
      originalPageWidth = pdfPage.view[2];
      originalPageHeight = pdfPage.view[3];
      scaleFactor = pdfViewport.width / originalPageWidth;
      canvas.width = pdfViewport.width;
      canvas.height = pdfViewport.height;
      const renderContext = {
        canvasContext: ctx,
        viewport: pdfViewport,
      };
      await pdfPage.render(renderContext).promise;
      pdfRenderedImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      showSuccess(`PDF loaded (${pageCount} pages). Draw a rectangle to select crop area. The same area will be cropped from every page.`);
    } catch (err) {
      showError('Failed to render PDF. This browser or environment may not support PDF.js workers.');
    }
  };
  fileReader.readAsArrayBuffer(file);
});

function redrawPDFWithCropBox() {
  if (!pdfRenderedImageData) return;
  ctx.putImageData(pdfRenderedImageData, 0, 0);
}

canvas.addEventListener('mousedown', (e) => {
  if (!pdfRenderedImageData) return;
  isDrawing = true;
  const rect = canvas.getBoundingClientRect();
  startX = e.clientX - rect.left;
  startY = e.clientY - rect.top;
});

canvas.addEventListener('mousemove', (e) => {
  if (!isDrawing || !pdfRenderedImageData) return;
  const rect = canvas.getBoundingClientRect();
  endX = e.clientX - rect.left;
  endY = e.clientY - rect.top;
  redrawPDFWithCropBox();
  ctx.beginPath();
  ctx.rect(startX, startY, endX - startX, endY - startY);
  ctx.lineWidth = 2;
  ctx.strokeStyle = 'red';
  ctx.stroke();
});

canvas.addEventListener('mouseup', () => {
  if (!pdfRenderedImageData) return;
  isDrawing = false;
  cropRect = {
    x: Math.min(startX, endX),
    y: Math.min(startY, endY),
    width: Math.abs(endX - startX),
    height: Math.abs(endY - startY)
  };
  // Show overlay
  redrawPDFWithCropBox();
  ctx.beginPath();
  ctx.rect(cropRect.x, cropRect.y, cropRect.width, cropRect.height);
  ctx.lineWidth = 2;
  ctx.strokeStyle = 'blue';
  ctx.stroke();
});

async function applyCrop() {
  if (!uploadedFile || !cropRect) { showError('Please upload a PDF and select a crop area.'); return; }
  try {
    const arrayBuffer = await uploadedFile.arrayBuffer();
    const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
    const pages = pdfDoc.getPages();
    // Convert canvas crop coordinates (from top-left) to PDF crop box (bottom-left origin)
    const cropX = cropRect.x / scaleFactor;
    const cropY = (canvas.height - (cropRect.y + cropRect.height)) / scaleFactor;
    const cropWidth = cropRect.width / scaleFactor;
    const cropHeight = cropRect.height / scaleFactor;
    if (cropWidth <= 0 || cropHeight <= 0) { showError('Invalid crop area selected.'); return; }
    // Apply crop to ALL pages!
    pages.forEach((page, idx) => {
      page.setCropBox(cropX, cropY, cropWidth, cropHeight);
      page.setMediaBox(cropX, cropY, cropWidth, cropHeight);
    });
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cropped_manual.pdf';
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 2000);
    showSuccess('PDF cropped & downloaded for ALL pages!');
  } catch (err) {
    showError('Failed to crop and download PDF.');
  }
}
</script>
